# Project Rules (.cursorrules)

You must follow these rules at all times.

---

## 1. Project Status \u0026 Issue Tracking
- **ALWAYS** check `PROJECT_STATUS_SUMMARY.md` first for current project state, completed tasks, and pending priorities
- **ALWAYS** check `issues.md` before starting a task to be aware of known pitfalls
- **IMMEDIATELY** log any new error or blocker in `issues.md` as soon as it is identified
- **UPDATE** `issues.md` with the resolution once fixed, including the "Cause" to prevent recurrence
- **UPDATE** `TASKS.md` when completing tasks
- **ALWAYS** check `issues.md` before marking any logic task as complete

### Documentation Structure (Updated Jan 16, 2026)
**NEW**: If confused about which file to use, see `docs/DOCUMENTATION_GUIDE.md` for complete file relationship guide.

**Core Tracking Files (Use Daily):**
- `TASKS.md` - PRIMARY daily task tracker
- `ROADMAP_TRANSACTION_EXPLORER.md` - Transaction Explorer feature roadmap (Phases 1-6)
- `issues.md` - Bug log and debugging history

**Status & Overview Files (Reference):**
- `PROJECT_STATUS_SUMMARY.md` - ⭐ Comprehensive project overview (START HERE for status)
- `PROJECT_STATUS.md` - Recent updates and changelog
- `OVERVIEW.md` - Architecture overview (CONSOLIDATED - includes detection pipeline & file structure)

**Public-Facing Docs:**
- `README.md` - GitHub landing page
- `QUICKSTART.md` - Setup and quick start guide
- `SAMPLE_DATA_README.md` - Testing data guide

**File Relationships:**
```
ROADMAP_TRANSACTION_EXPLORER.md (Long-term feature plan)
    ↓ Creates specific tasks
TASKS.md (Daily execution tracker)
    ↓ Documents completion
PROJECT_STATUS.md (Recent changelog)
```

**Archived Files:**
- `docs/archive/project_overview.md` - Merged into OVERVIEW.md (Jan 16, 2026)
- `docs/archive/PDF-Parser-Possible.md` - Research notes

---
## 2. Testing
- All tests must pass before merging (currently 140/140 tests passing across 24 suites)
- Run `npm run test:run` before marking any logic task as complete.
- **TERMINATE NODE PROCESSES**: Always ensure all Node.js processes (test runners, dev servers) are terminated after testing to prevent resource leaks.
- Don't just rely on unit tests; verify in the browser (`http://localhost:5173`) when touching UI.
- **FINAL VERIFICATION**: After deployment, the FINAL verification MUST be performed on the production site: [https://plugitall.com/](https://plugitall.com/). Do NOT use old staging URLs (e.g., bmwseals.com).
- When a test fails after code changes, check if the blacklist or detection logic needs adjustment.

---

## 3. File Safety
- When using `replace_file_content`, check the surrounding lines to ensure you are not accidentally deleting imports or adjacent logic.
- Use specific, small chunks for replacements rather than large blocks if possible.

---

## 4. Environment
- Ensure `postcss.config.js` exists for Tailwind to work.
- Use `import type` for all TypeScript interfaces.

---

## 5. Environment Maintenance
- **ALWAYS** Kill stale terminals/processes before starting a new server.
- **ONLY 1 NODE INSTANCE**: Ensure only one Node.js instance (server or test) is running. Never spawn new instances without killing existing ones.
- **ENSURE** the server runs on Port 5173 (default). If usage blocked, `kill` the blocker, don't just increment the port.
- **READ** console errors carefully; if a dependency complains about missing plugins (e.g. PostCSS), fix the config immediately.

---

## 6. Subscription Detection Logic (Lessons Learned)

### Normalization (`src/utils/normalizer.ts`)
- Add special case overrides for services with multiple description formats (e.g., `PAYPAL *VISIBLESERV` → `VISIBLE`)
- Always normalize to UPPERCASE for consistent matching

### Blacklist (`src/utils/analyzer.ts`)
- **Move `isKnown` check ABOVE `BLACKLIST` check**. This allows known subscriptions (Amazon Prime) to bypass the retail blacklist.
- The BLACKLIST array is the first line of defense against false positives.
- **Add general retail** (EBAY, AMAZON, Etsy) to the blacklist to block one-off purchases while allowing their subscription plans.
- Check user screenshots for new false positives and add them to the blacklist.

### Clustering & Shopping Patterns
- Transactions are grouped by amount ($1 tolerance).
- **Shopping Pattern (isShoppingPattern)**: Defined as `clusters.length >= 3` (3+ different price points).
- **REJECT** shopping patterns unless it's a verified consolidation service (e.g., YouTube TV).
- This prevents eBay/Amazon's varying purchase amounts from being detected as subscriptions.

### Interval Classification
- **Use MEDIAN interval** instead of Average for metric calculation. This is more robust against outliers from old PDF data.
- **Consecutive Months Rule**: If `!isKnown`, require at least one 25-35 day interval for Monthly detection.
- **Span Check**: If `!isKnown`, reject Yearly unless the total statement span is > 300 days.
- If avg/median interval doesn't match any bucket, transaction is discarded as "Irregular".
- **Confidence**: Set to "Low" (Review) for all unknown merchants.

### High-Risk Price Validation (`subscription_pricing.json`)
- HIGH/EXTREME risk merchants require exact price match (Amazon, Walmart, Fabletics)
- MEDIUM/LOW risk merchants accept flexible pricing (YouTube TV, Netflix)
- Use `min_amount` to filter invalid charges (e.g., YouTube TV < $50 = wrong charge)
- Use `consolidate: true` for variable-price subs to merge into one card

### App State & Deduplication (`src/App.tsx`)
- Use REPLACE instead of MERGE when processing new uploads to avoid stale data persistence.
- **Dedupe inputs**: Create a unique key `date + amount + description.substring(0,20)` to prevent CSV+PDF overlaps from creating 0-day intervals.

### Bank-Specific Parsing Logic (Jan 16, 2026)
- **Automatic Detection**: Always implement a `detectBank()` function that scans the raw text of the first page (PDF) or headers (CSV).
- **Specialized Routing**: Route parsing to isolated functions (e.g., `parseUSAASpecific`) based on the detected bank.
- **Table-Aware Design**: For complex multi-column PDFs (USAA), group text items by Y-coordinate and use X-coordinate boundaries for column mapping.
- **Description Merging**: In table-aware parsers, always check if the next line's text falls within the "Description" column's X-range and append it to the current transaction if it does.
- **Isolated Generic Parser**: Always maintain a `parseGenericSpecific` function as a fallback to ensure stability for unknown formats.
- **Sign Logic Protocol**:
  - `CR` / Credit Column → POSITIVE
  - `DR` / Debit Column / Parentheses / Trailing Minus → NEGATIVE
- **Tests**: Every new bank-specific parser MUST have its own diagnostic test file (e.g., `tests/usaa_content.test.ts`).

---

## 7. Pre-Commit Hooks

Pre-commit is installed and runs automatically on every `git commit`.

### Installed Hooks
- **check-added-large-files**, **check-case-conflict**, **check-json**, **check-yaml**, **check-merge-conflict**
- **end-of-file-fixer**, **trailing-whitespace**
- **Checkov** — Security scanning (Terraform/K8s)
- **Gitleaks** — Secret/credential detection
- **Prettier** — Code formatting (.ts, .tsx, .json, .md, .yaml)
- **ESLint** — TypeScript/React linting

### Running Manually
```bash
python -m pre_commit run --all-files
```

### Common Issues
- **@ts-ignore forbidden**: Use `@ts-expect-error` instead
- **Unused @ts-expect-error**: Remove directive if TypeScript resolves the type
- **`any` types**: Add `// eslint-disable-next-line @typescript-eslint/no-explicit-any` for pdfjs-dist items
- **JSON comments**: `tsconfig.app.json` and `tsconfig.node.json` cannot have `/* ... */` comments
- **Useless escapes**: In regex character classes `[...]`, don't escape `/` or `.`

---

## 8. Subscription Database

### Data Files (`src/data/`)
- **`subs.json`** (292 entries) — Primary subscription database for detection/matching
- **`subscription_pricing.json`** (193 entries) — Pricing validation and risk assessment
- **`subscriptions_master.json`** — Source master database (~500+ services)
- **`subscriptions_master_sup_url.json`** — Fallback URL updates

### Field Schema (`subs.json`)
| Field | Description |
|-------|-------------|
| `id` | Unique identifier (lowercase, underscores) |
| `name` | Display name |
| `regex_keywords` | Array of patterns to match descriptions |
| `logo` | Clearbit URL or local path |
| `cancel_url` | Primary cancellation URL |
| `fallback_url` | Backup URL if primary fails |
| `instructions` | Human-readable cancellation steps |

### Migration Script
Run `node scripts/migrate_master_data.cjs` to:
1. Merge new subscriptions from master files into `subs.json`
2. Extract pricing data to `subscription_pricing.json`
3. Apply fallback URLs

### Logo URLs
- Use Clearbit for logos: `https://logo.clearbit.com/{domain}`
- Example: `https://logo.clearbit.com/netflix.com`

---

## 9. GitHub Repository

- **Repo**: [https://github.com/teeesss/PlugItAll](https://github.com/teeesss/PlugItAll)
- **Credentials**: `.gitcreds` is in `.gitignore` — never commit secrets
- **Product Name**: Plug It All — "Find the leaks in your bank account"

---

## 10. Uploading to Web Server

- **MANDATORY**: After every successful local logic/UI verification, you **MUST** deploy to the live server.
- **PROCESS**:
    1. Run `npm run build` to generate the production bundle.
    2. Run `npm run deploy` to sync the `dist` folder to the FTP server.
    3. **ONLY upload modified files**: Never upload static image files (especially in `logos/`) unless they are new or modified. Use size-based or name-based comparison to skip existing files.
    4. Don't use && with powershell commands. Use ; instead.
- **VERIFICATION**: Always check the live URL (`https://www.bmwseals.com/plugit/`) after deployment to ensure changes are reflected.

---

## 11. Deployment & Asset Logic (Lessons Learned)

### Sync Engine (`scripts/deploy.js`)
- **CLEAN ASSETS**: Always call `cleanRemoteAssets()` to remove the remote `assets/` directory before syncing. This prevents stale, hashed JS/CSS bundles from lingering and causing "ghost" bugs.
- **FORCE UPLOAD**: Always force upload `index.html` and any files in `assets/`. Content-hashed assets change names frequently, and `index.html` must always point to the newest bundle.
- **SKIP LOGOS**: Skip re-uploading the `logos/` directory if files already exist remotely to save time/bandwidth.

### PDF Generation (`src/utils/pdfGenerator.ts`)
- **USE `doc.save()`**: For triggering downloads, always prefer `jsPDF.save('filename.pdf')` over manual blob creation (`URL.createObjectURL`). Standard blob triggers are frequently blocked or renamed to random GUID hashes by browser security policies on production domains.

---

## 12. User Action Targeting (Lessons Learned)

### Subscription Hiding (`App.tsx`, `SubscriptionCard.tsx`)
- **ALWAYS USE UNIQUE IDs**: When hiding/dismissing items, use a unique identifier (e.g., `${name}-${amount}`) instead of just the name. This prevents collateral hiding of same-name items with different prices.
- **ID Generation**: The `id` field is generated in `analyzer.ts` as `${name}-${averageAmount.toFixed(2)}` (e.g., `SIRIUSXM-7.71`).
- **Persistence**: The `persistence.ts` utility stores these IDs in localStorage. When filtering `visibleCandidates`, compare against `c.id`, not `c.name`.

---

## 13. Documentation Maintenance

### When Creating New Features
1. Add feature plan to `ROADMAP_TRANSACTION_EXPLORER.md` (if Transaction Explorer related)
2. Break down into specific tasks in `TASKS.md`
3. Update `PROJECT_STATUS.md` when completed
4. Update `PROJECT_STATUS_SUMMARY.md` if major milestone

### When Fixing Bugs
1. Check `issues.md` for similar past issues
2. Document the bug in `issues.md` immediately when found
3. Document the resolution in `issues.md` with "Cause" and "Fix"
4. Update `TASKS.md` when fixed

### When Updating Documentation
- Update test counts in: `README.md`, `QUICKSTART.md`, `OVERVIEW.md`, `.cursorrules`
- Keep `PROJECT_STATUS_SUMMARY.md` as single source of truth for overall status
- Archive old documentation to `docs/archive/` (don't delete, they have historical value)
- Update `docs/DOCUMENTATION_GUIDE.md` if file structure changes

### UI & State Management (Lessons Learned)
- **0-Subscription State**: ALWAYS handle the empty state gracefully. If a process (like parsing) completes but returns 0 results, the UI MUST provide feedback (e.g., transition to dashboard with "0 Found") rather than staying on the input screen.
- **Use REPLACE instead of MERGE** when processing new uploads to avoid stale data persistence.

### Current Stats (Update as needed)
- **Tests**: 142/142 passing across 25 test suites
- **Subscriptions**: 292 in database
- **Pricing Entries**: 193
- **Version**: v1.1.4-FINAL
- **Live URL**: https://plugitall.com/
